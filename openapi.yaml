openapi: 3.0.3
info:
  title: CPV Suggest API
  description: |
    AI-powered CPV (Common Procurement Vocabulary) code suggestion service.

    Uses Anthropic Claude 3.5 to suggest relevant CPV codes based on company descriptions
    or website URLs. All suggestions are validated against an internal CPV code database
    to prevent hallucinations.

    ## Features
    - AI-powered suggestions with confidence scores
    - URL content extraction for automated analysis
    - Synonym matching for better accuracy
    - Hierarchical CPV code structure with full paths
    - Specificity filtering (general to specific)
    - Redis caching for improved performance
    - Rate limiting and authentication via Laravel Sanctum

  version: 1.0.0
  contact:
    name: CPV Suggest API Support
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.cpv-suggest.example.com
    description: Production server

tags:
  - name: Health
    description: Health check and readiness endpoints
  - name: CPV Suggestion
    description: CPV code suggestion endpoints

paths:
  /api/healthz:
    get:
      summary: Basic health check
      description: Returns a simple health status indicating the service is running
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-10-15T12:34:56Z"

  /api/readyz:
    get:
      summary: Detailed readiness check
      description: Verifies database connection, Redis connection, and CPV codes are loaded
      tags:
        - Health
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ready
                  checks:
                    type: object
                    properties:
                      database:
                        type: boolean
                        example: true
                      redis:
                        type: boolean
                        example: true
                      cpv_codes:
                        type: boolean
                        example: true
                  timestamp:
                    type: string
                    format: date-time
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: not ready
                  checks:
                    type: object
                  errors:
                    type: array
                    items:
                      type: string

  /api/v1/cpv/suggest:
    post:
      summary: Suggest CPV codes
      description: |
        Suggests relevant CPV codes based on a company description or website URL.

        ## How it works
        1. Input is normalized (URL content is fetched if provided)
        2. LLM (Claude 3.5) analyzes the text and suggests CPV codes
        3. Each suggestion is validated against the CPV database
        4. Failed validations are matched against synonyms
        5. Results are ranked by confidence and deduplicated
        6. Optional specificity filtering is applied
        7. Top K results are returned
        8. Response is cached for 24 hours

        ## Specificity Filtering
        - **1 (Specific)**: Returns high-level codes (L4-L7), prefers children over parents
        - **2 (Medium)**: Returns medium-level codes (L2-L5), keeps both parents and children
        - **3 (General)**: Returns low-level codes (L1-L3), prefers parents over children
        - If not provided, no filtering is applied

        At least 50% of original results are retained through dynamic expansion.

      tags:
        - CPV Suggestion
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
                  maxLength: 2048
                  description: Website URL to analyze (content will be fetched and analyzed)
                  example: "https://www.interone.de"
                description:
                  type: string
                  maxLength: 5000
                  description: Company or service description text
                  example: "Wir bieten IT-Beratung und Cloud-Migration an"
                language:
                  type: string
                  enum: [de, en, fr, it, es]
                  default: de
                  description: Language for analysis and response
                  example: de
                top_k:
                  type: integer
                  minimum: 1
                  maximum: 25
                  default: 12
                  description: Maximum number of CPV codes to return
                  example: 5
                specificity:
                  type: integer
                  enum: [1, 2, 3]
                  description: |
                    Filter results by specificity level:
                    - 1 = Very specific (high levels 4-7, prefer children)
                    - 2 = Medium (middle levels 2-5, keep both)
                    - 3 = Very general (low levels 1-3, prefer parents)
                  example: 1
              required:
                - description
              anyOf:
                - required: [url]
                - required: [description]
            examples:
              with_description:
                summary: Suggest with description
                value:
                  description: "Wir bieten IT-Beratung, Cloud-Migration und Software-Entwicklung an"
                  language: "de"
                  top_k: 10
                  specificity: 1
              with_url:
                summary: Suggest with URL
                value:
                  url: "https://www.interone.de"
                  language: "de"
                  top_k: 5
                  specificity: 1
              with_both:
                summary: Suggest with both URL and description
                value:
                  url: "https://www.example.com"
                  description: "Additional context about the company"
                  language: "en"
                  top_k: 12
      responses:
        '200':
          description: Successful response with CPV code suggestions
          content:
            application/json:
              schema:
                type: object
                properties:
                  query_id:
                    type: string
                    description: Unique identifier for this query (16-character hex)
                    example: "35cbf49687494a21"
                  language_detected:
                    type: string
                    description: Language used for analysis
                    example: "de"
                  codes:
                    type: array
                    description: Array of suggested CPV codes, sorted by confidence
                    items:
                      type: object
                      properties:
                        cpv:
                          type: string
                          pattern: '^\d{8}$'
                          description: 8-digit CPV code
                          example: "72413000"
                        cpv_full:
                          type: string
                          pattern: '^\d{8}-\d$'
                          description: Full CPV code with check digit
                          example: "72413000-8"
                        check_digit:
                          type: integer
                          minimum: 0
                          maximum: 9
                          description: Check digit for validation
                          example: 8
                        title:
                          type: string
                          description: Official CPV code description
                          example: "Website-Gestaltung."
                        level:
                          type: integer
                          minimum: 1
                          maximum: 7
                          description: Hierarchy level (1=division, 7=most specific)
                          example: 4
                        path:
                          type: array
                          description: Full hierarchical path from root to this code
                          items:
                            type: string
                          example:
                            - "72000000 - IT-Dienste: Beratung, Software-Entwicklung, Internet und Hilfestellung."
                            - "72400000 - Internetdienste."
                            - "72410000 - Diensteanbieter."
                            - "72413000 - Website-Gestaltung."
                        confidence:
                          type: number
                          format: float
                          minimum: 0.0
                          maximum: 1.0
                          description: Confidence score from AI model
                          example: 0.95
                        source:
                          type: string
                          enum: [llm+validated, synonym]
                          description: How this code was matched
                          example: "llm+validated"
                        rationale:
                          type: string
                          description: Explanation why this code was suggested
                          example: "Explicitly mentions state-of-the-art web solutions and digital touchpoints"
                  rationale:
                    type: string
                    description: Overall explanation of the suggestions
                    example: "Interone is a comprehensive digital agency offering IT services, web development, creative marketing campaigns, and technology-driven solutions."
                  warnings:
                    type: array
                    description: Any warnings or issues during processing
                    items:
                      type: string
                    example: []
                  cached:
                    type: boolean
                    description: Whether this response was served from cache
                    example: false
              example:
                query_id: "35cbf49687494a21"
                language_detected: "de"
                codes:
                  - cpv: "72413000"
                    cpv_full: "72413000-8"
                    check_digit: 8
                    title: "Website-Gestaltung."
                    level: 4
                    path:
                      - "72000000 - IT-Dienste: Beratung, Software-Entwicklung, Internet und Hilfestellung."
                      - "72400000 - Internetdienste."
                      - "72410000 - Diensteanbieter."
                      - "72413000 - Website-Gestaltung."
                    confidence: 0.95
                    source: "llm+validated"
                    rationale: "Explicitly mentions state-of-the-art web solutions"
                  - cpv: "79342200"
                    cpv_full: "79342200-5"
                    check_digit: 5
                    title: "Reklamedienste."
                    level: 5
                    path:
                      - "79000000 - Dienstleistungen für Unternehmen: Recht, Marketing, Consulting, Einstellungen, Druck und Sicherheit."
                      - "79300000 - Markt- und Wirtschaftsforschung; Umfragen und Statistiken."
                      - "79340000 - Werbe- und Marketingdienstleistungen."
                      - "79342000 - Marketing."
                      - "79342200 - Reklamedienste."
                    confidence: 0.93
                    source: "llm+validated"
                    rationale: "Creative campaigns and content creation mentioned"
                rationale: "Interone is a comprehensive digital agency offering IT services, web development, creative marketing campaigns, and technology-driven solutions."
                warnings: []
                cached: false
        '400':
          description: Bad request - validation errors
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Either url or description must be provided."
                  errors:
                    type: object
                    additionalProperties:
                      type: array
                      items:
                        type: string
              examples:
                missing_input:
                  summary: Missing required input
                  value:
                    message: "Either url or description must be provided."
                    errors:
                      url: ["Either url or description must be provided."]
                      description: ["Either url or description must be provided."]
                invalid_specificity:
                  summary: Invalid specificity value
                  value:
                    message: "The specificity value must be 1 (specific), 2 (medium), or 3 (general)."
                    errors:
                      specificity: ["The specificity value must be 1 (specific), 2 (medium), or 3 (general)."]
        '401':
          description: Unauthorized - missing or invalid authentication token
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Unauthenticated."
        '422':
          description: Unprocessable entity - validation failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  errors:
                    type: object
        '429':
          description: Too many requests - rate limit exceeded
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Too Many Attempts."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Service temporarily unavailable"
                  warnings:
                    type: array
                    items:
                      type: string

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Laravel Sanctum token authentication.

        Include the token in the Authorization header:
        `Authorization: Bearer YOUR_TOKEN`

  schemas:
    CpvCode:
      type: object
      properties:
        cpv:
          type: string
          pattern: '^\d{8}$'
          description: 8-digit CPV code
        cpv_full:
          type: string
          pattern: '^\d{8}-\d$'
          description: Full CPV code with check digit
        check_digit:
          type: integer
          minimum: 0
          maximum: 9
        title:
          type: string
          description: Official CPV code title
        level:
          type: integer
          minimum: 1
          maximum: 7
          description: Hierarchy level
        path:
          type: array
          items:
            type: string
          description: Full hierarchical path
        confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
        source:
          type: string
          enum: [llm+validated, synonym]
        rationale:
          type: string

    Error:
      type: object
      properties:
        message:
          type: string
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string

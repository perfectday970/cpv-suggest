openapi: 3.0.3
info:
  title: CPV Suggest API
  description: |
    AI-powered CPV (Common Procurement Vocabulary) code suggestion service.

    Uses Anthropic Claude 3.5 to suggest relevant CPV codes based on company descriptions
    or website URLs. All suggestions are validated against an internal CPV code database
    to prevent hallucinations.

    ## Features
    - AI-powered suggestions with confidence scores
    - URL content extraction for automated analysis
    - Synonym matching for better accuracy
    - Hierarchical CPV code structure with full paths
    - Specificity filtering (general to specific)
    - Redis caching for improved performance
    - Rate limiting and authentication via Laravel Sanctum

  version: 1.0.0
  contact:
    name: CPV Suggest API Support
  license:
    name: MIT

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://api.cpv-suggest.example.com
    description: Production server

tags:
  - name: Health
    description: Health check and readiness endpoints
  - name: CPV Suggestion
    description: CPV code suggestion endpoints
  - name: Bekanntmachungen
    description: Public procurement announcements (Bekanntmachungen)

paths:
  /api/healthz:
    get:
      summary: Basic health check
      description: Returns a simple health status indicating the service is running
      tags:
        - Health
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time
                    example: "2025-10-15T12:34:56Z"

  /api/readyz:
    get:
      summary: Detailed readiness check
      description: Verifies database connection, Redis connection, and CPV codes are loaded
      tags:
        - Health
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ready
                  checks:
                    type: object
                    properties:
                      database:
                        type: boolean
                        example: true
                      redis:
                        type: boolean
                        example: true
                      cpv_codes:
                        type: boolean
                        example: true
                  timestamp:
                    type: string
                    format: date-time
        '503':
          description: Service is not ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: not ready
                  checks:
                    type: object
                  errors:
                    type: array
                    items:
                      type: string

  /api/v1/cpv/suggest:
    post:
      summary: Suggest CPV codes
      description: |
        Suggests relevant CPV codes based on a company description or website URL.

        ## How it works
        1. Input is normalized (URL content is fetched if provided)
        2. LLM (Claude 3.5) analyzes the text and suggests CPV codes
        3. Each suggestion is validated against the CPV database
        4. Failed validations are matched against synonyms
        5. Results are ranked by confidence and deduplicated
        6. Optional specificity filtering is applied
        7. Top K results are returned
        8. Response is cached for 24 hours

        ## Specificity Filtering
        - **1 (Specific)**: Returns high-level codes (L4-L7), prefers children over parents
        - **2 (Medium)**: Returns medium-level codes (L2-L5), keeps both parents and children
        - **3 (General)**: Returns low-level codes (L1-L3), prefers parents over children
        - If not provided, no filtering is applied

        At least 50% of original results are retained through dynamic expansion.

      tags:
        - CPV Suggestion
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url:
                  type: string
                  format: uri
                  maxLength: 2048
                  description: Website URL to analyze (content will be fetched and analyzed)
                  example: "https://www.interone.de"
                description:
                  type: string
                  maxLength: 5000
                  description: Company or service description text
                  example: "Wir bieten IT-Beratung und Cloud-Migration an"
                language:
                  type: string
                  enum: [de, en, fr, it, es]
                  default: de
                  description: Language for analysis and response
                  example: de
                top_k:
                  type: integer
                  minimum: 1
                  maximum: 25
                  default: 12
                  description: Maximum number of CPV codes to return
                  example: 5
                specificity:
                  type: integer
                  enum: [1, 2, 3]
                  description: |
                    Filter results by specificity level:
                    - 1 = Very specific (high levels 4-7, prefer children)
                    - 2 = Medium (middle levels 2-5, keep both)
                    - 3 = Very general (low levels 1-3, prefer parents)
                  example: 1
              required:
                - description
              anyOf:
                - required: [url]
                - required: [description]
            examples:
              with_description:
                summary: Suggest with description
                value:
                  description: "Wir bieten IT-Beratung, Cloud-Migration und Software-Entwicklung an"
                  language: "de"
                  top_k: 10
                  specificity: 1
              with_url:
                summary: Suggest with URL
                value:
                  url: "https://www.interone.de"
                  language: "de"
                  top_k: 5
                  specificity: 1
              with_both:
                summary: Suggest with both URL and description
                value:
                  url: "https://www.example.com"
                  description: "Additional context about the company"
                  language: "en"
                  top_k: 12
      responses:
        '200':
          description: Successful response with CPV code suggestions
          content:
            application/json:
              schema:
                type: object
                properties:
                  query_id:
                    type: string
                    description: Unique identifier for this query (16-character hex)
                    example: "35cbf49687494a21"
                  language_detected:
                    type: string
                    description: Language used for analysis
                    example: "de"
                  codes:
                    type: array
                    description: Array of suggested CPV codes, sorted by confidence
                    items:
                      type: object
                      properties:
                        cpv:
                          type: string
                          pattern: '^\d{8}$'
                          description: 8-digit CPV code
                          example: "72413000"
                        cpv_full:
                          type: string
                          pattern: '^\d{8}-\d$'
                          description: Full CPV code with check digit
                          example: "72413000-8"
                        check_digit:
                          type: integer
                          minimum: 0
                          maximum: 9
                          description: Check digit for validation
                          example: 8
                        title:
                          type: string
                          description: Official CPV code description
                          example: "Website-Gestaltung."
                        level:
                          type: integer
                          minimum: 1
                          maximum: 7
                          description: Hierarchy level (1=division, 7=most specific)
                          example: 4
                        path:
                          type: array
                          description: Full hierarchical path from root to this code
                          items:
                            type: string
                          example:
                            - "72000000 - IT-Dienste: Beratung, Software-Entwicklung, Internet und Hilfestellung."
                            - "72400000 - Internetdienste."
                            - "72410000 - Diensteanbieter."
                            - "72413000 - Website-Gestaltung."
                        confidence:
                          type: number
                          format: float
                          minimum: 0.0
                          maximum: 1.0
                          description: Confidence score from AI model
                          example: 0.95
                        source:
                          type: string
                          enum: [llm+validated, synonym]
                          description: How this code was matched
                          example: "llm+validated"
                        rationale:
                          type: string
                          description: Explanation why this code was suggested
                          example: "Explicitly mentions state-of-the-art web solutions and digital touchpoints"
                  rationale:
                    type: string
                    description: Overall explanation of the suggestions
                    example: "Interone is a comprehensive digital agency offering IT services, web development, creative marketing campaigns, and technology-driven solutions."
                  warnings:
                    type: array
                    description: Any warnings or issues during processing
                    items:
                      type: string
                    example: []
                  cached:
                    type: boolean
                    description: Whether this response was served from cache
                    example: false
              example:
                query_id: "35cbf49687494a21"
                language_detected: "de"
                codes:
                  - cpv: "72413000"
                    cpv_full: "72413000-8"
                    check_digit: 8
                    title: "Website-Gestaltung."
                    level: 4
                    path:
                      - "72000000 - IT-Dienste: Beratung, Software-Entwicklung, Internet und Hilfestellung."
                      - "72400000 - Internetdienste."
                      - "72410000 - Diensteanbieter."
                      - "72413000 - Website-Gestaltung."
                    confidence: 0.95
                    source: "llm+validated"
                    rationale: "Explicitly mentions state-of-the-art web solutions"
                  - cpv: "79342200"
                    cpv_full: "79342200-5"
                    check_digit: 5
                    title: "Reklamedienste."
                    level: 5
                    path:
                      - "79000000 - Dienstleistungen für Unternehmen: Recht, Marketing, Consulting, Einstellungen, Druck und Sicherheit."
                      - "79300000 - Markt- und Wirtschaftsforschung; Umfragen und Statistiken."
                      - "79340000 - Werbe- und Marketingdienstleistungen."
                      - "79342000 - Marketing."
                      - "79342200 - Reklamedienste."
                    confidence: 0.93
                    source: "llm+validated"
                    rationale: "Creative campaigns and content creation mentioned"
                rationale: "Interone is a comprehensive digital agency offering IT services, web development, creative marketing campaigns, and technology-driven solutions."
                warnings: []
                cached: false
        '400':
          description: Bad request - validation errors
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Either url or description must be provided."
                  errors:
                    type: object
                    additionalProperties:
                      type: array
                      items:
                        type: string
              examples:
                missing_input:
                  summary: Missing required input
                  value:
                    message: "Either url or description must be provided."
                    errors:
                      url: ["Either url or description must be provided."]
                      description: ["Either url or description must be provided."]
                invalid_specificity:
                  summary: Invalid specificity value
                  value:
                    message: "The specificity value must be 1 (specific), 2 (medium), or 3 (general)."
                    errors:
                      specificity: ["The specificity value must be 1 (specific), 2 (medium), or 3 (general)."]
        '401':
          description: Unauthorized - missing or invalid authentication token
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Unauthenticated."
        '422':
          description: Unprocessable entity - validation failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  errors:
                    type: object
        '429':
          description: Too many requests - rate limit exceeded
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Too Many Attempts."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Service temporarily unavailable"
                  warnings:
                    type: array
                    items:
                      type: string

  /api/v1/bekanntmachungen:
    get:
      summary: List all Bekanntmachungen
      description: |
        Retrieves a paginated list of all procurement announcements (Bekanntmachungen),
        sorted by publication date (newest first).
      tags:
        - Bekanntmachungen
      parameters:
        - name: limit
          in: query
          description: Number of items per page
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 20
            example: 20
        - name: page
          in: query
          description: Page number
          schema:
            type: integer
            minimum: 1
            default: 1
            example: 1
      responses:
        '200':
          description: Successful response with paginated Bekanntmachungen
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BekanntmachungListResponse'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /api/v1/bekanntmachungen/{id}:
    get:
      summary: Get a single Bekanntmachung by ID
      description: Retrieves detailed information about a specific procurement announcement
      tags:
        - Bekanntmachungen
      parameters:
        - name: id
          in: path
          required: true
          description: Bekanntmachung ID
          schema:
            type: integer
            example: 1
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: true
                  data:
                    $ref: '#/components/schemas/Bekanntmachung'
        '404':
          description: Bekanntmachung not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  message:
                    type: string
                    example: "Bekanntmachung not found"
        '429':
          $ref: '#/components/responses/RateLimitError'

  /api/v1/bekanntmachungen/search:
    post:
      summary: Search Bekanntmachungen by CPV codes
      description: |
        Search for procurement announcements that match one or more CPV codes.
        Results include all Bekanntmachungen that have at least one of the specified CPV codes.

        ## Filtering Options
        - **cpv_codes** (required): Array of 8-digit CPV codes
        - **published_after/before**: Filter by publication date range
        - **deadline_after**: Only include announcements with submission deadline after this date
        - **typ**: Filter by procurement type (e.g., "Offenes Verfahren", "Verhandlungsverfahren")
        - **min_value/max_value**: Filter by estimated contract value
        - **limit**: Maximum number of results to return (default: 20, max: 100)
      tags:
        - Bekanntmachungen
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BekanntmachungSearchRequest'
            examples:
              simple_search:
                summary: Simple search by CPV code
                value:
                  cpv_codes: ["72000000"]
                  limit: 10
              advanced_search:
                summary: Advanced search with filters
                value:
                  cpv_codes: ["72000000", "72200000"]
                  published_after: "2025-09-01"
                  deadline_after: "2025-11-01"
                  min_value: 100000
                  typ: "Offenes Verfahren"
                  limit: 20
              multi_cpv:
                summary: Search with multiple CPV codes
                value:
                  cpv_codes: ["72000000", "45000000", "39100000"]
                  limit: 50
      responses:
        '200':
          description: Successful search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BekanntmachungSearchResponse'
        '400':
          description: Bad request - validation errors
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Unprocessable entity - validation failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                    example: false
                  errors:
                    type: object
        '429':
          $ref: '#/components/responses/RateLimitError'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Laravel Sanctum token authentication.

        Include the token in the Authorization header:
        `Authorization: Bearer YOUR_TOKEN`

  responses:
    RateLimitError:
      description: Too many requests - rate limit exceeded (60 requests per minute)
      content:
        application/json:
          schema:
            type: object
            properties:
              message:
                type: string
                example: "Too Many Attempts."

  schemas:
    Bekanntmachung:
      type: object
      properties:
        id:
          type: integer
          description: Unique identifier
          example: 1
        veroeffentlicht:
          type: string
          format: date
          description: Publication date
          example: "2025-10-01"
        angebotsfrist:
          type: string
          format: date
          nullable: true
          description: Submission deadline
          example: "2025-11-15"
        kurzbezeichnung:
          type: string
          description: Short title of the procurement
          example: "IT-Dienstleistungen für Verwaltungsmodernisierung"
        typ:
          type: string
          description: Procurement type
          enum:
            - Offenes Verfahren
            - Verhandlungsverfahren
            - Nicht offenes Verfahren
            - Wettbewerblicher Dialog
          example: "Offenes Verfahren"
        vergabeplattform:
          type: string
          description: Publication platform
          example: "bund.de"
        geschaetzter_auftragswert:
          type: number
          format: decimal
          nullable: true
          description: Estimated contract value in EUR
          example: 250000.00
        beschreibung:
          type: string
          nullable: true
          description: Detailed description of the procurement
          example: "Ausschreibung für umfassende IT-Beratungsleistungen zur Digitalisierung der Verwaltungsprozesse."
        cpv_codes:
          type: array
          description: Associated CPV codes
          items:
            type: object
            properties:
              code:
                type: string
                pattern: '^\d{8}$'
                description: 8-digit CPV code
                example: "72000000"
              title:
                type: string
                description: CPV code description
                example: "IT-Dienste: Beratung, Software-Entwicklung, Internet und Hilfestellung."

    BekanntmachungSearchRequest:
      type: object
      required:
        - cpv_codes
      properties:
        cpv_codes:
          type: array
          description: Array of 8-digit CPV codes to search for
          minItems: 1
          items:
            type: string
            pattern: '^\d{8}$'
            example: "72000000"
        published_after:
          type: string
          format: date
          description: Filter by publication date (from)
          example: "2025-09-01"
        published_before:
          type: string
          format: date
          description: Filter by publication date (until)
          example: "2025-12-31"
        deadline_after:
          type: string
          format: date
          description: Only include announcements with deadline after this date
          example: "2025-11-01"
        typ:
          type: string
          description: Filter by procurement type
          example: "Offenes Verfahren"
        min_value:
          type: number
          format: decimal
          minimum: 0
          description: Minimum estimated contract value in EUR
          example: 100000
        max_value:
          type: number
          format: decimal
          minimum: 0
          description: Maximum estimated contract value in EUR
          example: 1000000
        limit:
          type: integer
          minimum: 1
          maximum: 100
          default: 20
          description: Maximum number of results to return
          example: 20

    BekanntmachungSearchResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        count:
          type: integer
          description: Number of results returned
          example: 5
        data:
          type: array
          items:
            $ref: '#/components/schemas/Bekanntmachung'

    BekanntmachungListResponse:
      type: object
      properties:
        success:
          type: boolean
          example: true
        count:
          type: integer
          description: Number of items on current page
          example: 20
        total:
          type: integer
          description: Total number of items
          example: 49
        current_page:
          type: integer
          example: 1
        last_page:
          type: integer
          example: 3
        data:
          type: array
          items:
            $ref: '#/components/schemas/Bekanntmachung'

    CpvCode:
      type: object
      properties:
        cpv:
          type: string
          pattern: '^\d{8}$'
          description: 8-digit CPV code
        cpv_full:
          type: string
          pattern: '^\d{8}-\d$'
          description: Full CPV code with check digit
        check_digit:
          type: integer
          minimum: 0
          maximum: 9
        title:
          type: string
          description: Official CPV code title
        level:
          type: integer
          minimum: 1
          maximum: 7
          description: Hierarchy level
        path:
          type: array
          items:
            type: string
          description: Full hierarchical path
        confidence:
          type: number
          format: float
          minimum: 0.0
          maximum: 1.0
        source:
          type: string
          enum: [llm+validated, synonym]
        rationale:
          type: string

    Error:
      type: object
      properties:
        message:
          type: string
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
